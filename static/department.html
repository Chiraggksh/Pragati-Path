<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Departmental Analytics Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #333;
  }
  .navbar, .card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
  }
  .dashboard-header {
    text-align: center;
    color: white;
    margin: 3rem 0 2rem;
  }
  .stat-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 2rem;
    text-align: center;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    margin-bottom: 1.5rem;
  }
  .stat-number {
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    background: linear-gradient(90deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .stat-label {
    font-size: 1rem;
    color: #666;
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 1px;
  }
  .chart-container {
    position: relative;
    height: 400px;
    margin: 2rem 0;
  }
  .ai-insight {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px;
    padding: 2rem;
    margin: 2rem 0;
    font-size: 1.1rem;
    line-height: 1.5;
  }
</style>
</head>
<body>
<nav class="navbar fixed-top px-4 py-2">
  <a class="navbar-brand" href="#"><i class="fas fa-chart-line"></i> Departmental Analytics</a>
  <button id="refreshBtn" class="btn btn-primary ms-auto"><i class="fas fa-sync-alt"></i> Refresh Data</button>
</nav>

<div class="container mt-5 pt-5">
  <div class="dashboard-header">
    <h1><i class="fas fa-building"></i> Department Performance Dashboard</h1>
    <p>Comprehensive insights into civic issue management and departmental efficiency</p>
  </div>

  <!-- Overview Statistics -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-number" id="totalIssues">0</div>
        <div class="stat-label">Total Issues</div>
        <div class="stat-sublabel">All time</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-number" id="acknowledgmentRate">0%</div>
        <div class="stat-label">Acknowledgment Rate</div>
        <div class="stat-sublabel" id="acknowledgedCount">0 acknowledged</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-number" id="completionRate">0%</div>
        <div class="stat-label">Completion Rate</div>
        <div class="stat-sublabel" id="completedCount">0 completed</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card">
        <div class="stat-number" id="pendingIssues">0</div>
        <div class="stat-label">Pending Issues</div>
        <div class="stat-sublabel">Require attention</div>
      </div>
    </div>
  </div>

  <!-- Category and Constituency Charts -->
  <div class="row">
    <div class="col-md-6">
      <div class="card p-3">
        <h3><i class="fas fa-chart-bar"></i> Category Performance</h3>
        <div class="chart-container">
          <canvas id="categoryChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3">
        <h3><i class="fas fa-map-marked-alt"></i> Constituency Performance</h3>
        <div class="chart-container">
          <canvas id="constituencyChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Time Series Chart -->
  <div class="card p-3 mt-4">
    <h3><i class="fas fa-chart-line"></i> Issues Trend Last 30 Days</h3>
    <div class="chart-container">
      <canvas id="timeSeriesChart"></canvas>
    </div>
  </div>

  <!-- Urgent Issues -->
  <div class="card p-3 mt-4">
    <h3><i class="fas fa-exclamation-triangle"></i> Urgent Issues</h3>
    <div id="urgentIssuesContainer" class="mt-3">
      <p class="text-center text-muted">Loading urgent issues...</p>
    </div>
  </div>

  <!-- AI Insight -->
  <div class="ai-insight mt-4">
    <h4><i class="fas fa-robot"></i> AI-Powered Insight</h4>
    <p id="aiInsight">Generating AI insights...</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Dashboard data and charts
  let dashboardData = null;
  let charts = {};

  document.addEventListener("DOMContentLoaded", () => {
    loadDashboardData();
    document.getElementById("refreshBtn").addEventListener("click", loadDashboardData);
  });

  async function loadDashboardData() {
    try {
      const response = await fetch("/api/departmentanalytics");
      const data = await response.json();
      if (!response.ok) throw new Error(data.message || "Failed to load data");
      dashboardData = data;
      updateDashboard(data);
    } catch (error) {
      alert("Failed to load dashboard data. Please try again.");
      console.error("Dashboard load error:", error);
    }
  }

  function updateDashboard(data) {
    document.getElementById("totalIssues").textContent = data.overview.total_issues || 0;
    document.getElementById("acknowledgmentRate").textContent = (data.overview.acknowledgment_rate || 0) + "%";
    document.getElementById("acknowledgedCount").textContent = (data.overview.acknowledged_issues || 0) + " acknowledged";
    document.getElementById("completionRate").textContent = (data.overview.completion_rate || 0) + "%";
    document.getElementById("completedCount").textContent = (data.overview.completed_issues || 0) + " completed";
    document.getElementById("pendingIssues").textContent = data.overview.pending_issues || 0;

    updateCategoryChart(data.category_performance);
    updateConstituencyChart(data.constituency_performance);
    updateTimeSeriesChart(data.time_series);
    updateUrgentIssues(data.urgent_issues);

    // Show AI Insight text directly
    document.getElementById("aiInsight").textContent = data.ai_insight ;
  }

  function updateCategoryChart(categoryData) {
    const ctx = document.getElementById("categoryChart").getContext("2d");
    if(charts.category) charts.category.destroy();
    charts.category = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: categoryData.map(d => d.category),
        datasets: [{
          data: categoryData.map(d => d.total_issues),
          backgroundColor: ['#667eea','#f093fb','#4facfe','#43e97b','#fa709a'],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom', labels: { padding: 20, font: {size: 12, weight: '600'} } } }
      }
    });
  }

  function updateConstituencyChart(data) {
    const ctx = document.getElementById("constituencyChart").getContext("2d");
    if(charts.constituency) charts.constituency.destroy();
    charts.constituency = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: data.map(d => d.constituency),
        datasets: [{
          label: 'Total Issues',
          data: data.map(d => d.total_issues),
          backgroundColor: 'rgba(102, 126, 234, 0.8)',
          borderRadius: 10
        },{
          label: 'Completed',
          data: data.map(d => d.completed),
          backgroundColor: 'rgba(67, 233, 123, 0.8)',
          borderRadius: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true }, x: { ticks: { maxRotation: 45 }} },
        plugins: { legend: { position: 'top' } }
      }
    });
  }

  function updateTimeSeriesChart(data) {
    const ctx = document.getElementById("timeSeriesChart").getContext("2d");
    if(charts.timeSeries) charts.timeSeries.destroy();
    charts.timeSeries = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(d => new Date(d.date).toLocaleDateString()),
        datasets: [{
          label: 'Issues Reported',
          data: data.map(d => d.issues_reported),
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          fill: true,
          tension: 0.4
        },{
          label: 'Issues Completed',
          data: data.map(d => d.issues_completed),
          borderColor: '#43e97b',
          backgroundColor: 'rgba(67, 233, 123, 0.1)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { position: 'top' } }
      }
    });
  }

  function updateUrgentIssues(data) {
    const container = document.getElementById("urgentIssuesContainer");
    if (!data || data.length === 0) {
      container.innerHTML = '<p class="text-center text-muted">No urgent issues found.</p>';
      return;
    }
    container.innerHTML = data.map(issue => `
      <div class="urgent-issue p-3 mb-2 rounded">
        <h6>${escapeHtml(issue.title)}</h6>
        <div class="d-flex justify-content-between align-items-center">
          <small class="badge bg-secondary">${escapeHtml(issue.category)}</small>
          <small class="text-muted">${escapeHtml(issue.constituency)}</small>
          <span class="badge bg-danger">${issue.upvotes} upvotes</span>
          <small class="text-muted">${issue.days_pending} days pending</small>
        </div>
      </div>
    `).join('');
  }

  function escapeHtml(text) {
    if(!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
</body>
</html>
